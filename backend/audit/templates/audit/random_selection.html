{% extends "audit/base.html" %}
{% block title %}Random Selection{% endblock %}
{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h2>Random Audit Selection</h2>
    {% if is_educator %}
    <form method="post" action="{% url 'audit:random_selection_generate' %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary">Generate New Selection</button>
    </form>
    {% endif %}
</div>

<!-- Active Selection -->
{% if active_selection %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            Active Selection: {{ active_selection.week_start_date|date:"d M Y" }} - {{ active_selection.week_end_date|date:"d M Y" }}
        </h5>
        <small class="text-muted">Generated by {{ active_selection.generated_by }} on {{ active_selection.generated_date|date:"d M Y H:i" }}</small>
    </div>
    <div class="card-body p-0">
        <table class="table table-hover table-sm mb-0">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Location</th>
                    <th>Service Line</th>
                    <th>Days Since Audit</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            {% for item in active_selection.items.all %}
            <tr class="{% if item.audit_status == 'Completed' %}table-success{% elif item.audit_status == 'Skipped' %}table-light{% endif %}">
                <td>{{ item.selection_rank }}</td>
                <td><a href="{% url 'audit:trolley_detail' item.location.pk %}">{{ item.location.display_name }}</a></td>
                <td><span class="badge bg-secondary">{{ item.location.service_line.abbreviation }}</span></td>
                <td>{% if item.days_since_audit is not None %}{{ item.days_since_audit }}{% else %}Never{% endif %}</td>
                <td>{{ item.priority_score }}</td>
                <td>
                    <span class="badge bg-{% if item.audit_status == 'Completed' %}success{% elif item.audit_status == 'Skipped' %}secondary{% else %}warning{% endif %}">
                        {{ item.audit_status }}
                    </span>
                </td>
                <td>
                    {% if item.audit_status == 'Pending' and is_auditor %}
                    <form method="post" action="{% url 'audit:audit_start' item.location.pk %}" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="selection_item" value="{{ item.pk }}">
                        <button type="submit" class="btn btn-sm btn-outline-primary">Start Audit</button>
                    </form>
                    {% elif item.audit %}
                    <a href="{% url 'audit:audit_detail' item.audit.pk %}" class="btn btn-sm btn-outline-success">View Audit</a>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="7" class="text-muted text-center">No items in this selection</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="alert alert-info">
    No active random audit selection. {% if is_educator %}Click "Generate New Selection" to create one.{% endif %}
</div>
{% endif %}

<!-- Past Selections -->
{% if past_selections %}
<div class="card">
    <div class="card-header"><h5 class="mb-0">Past Selections</h5></div>
    <div class="card-body p-0">
        <table class="table table-sm mb-0">
            <thead>
                <tr>
                    <th>Week</th>
                    <th>Generated By</th>
                    <th>Items</th>
                    <th>Completed</th>
                    <th>Skipped</th>
                </tr>
            </thead>
            <tbody>
            {% for sel in past_selections %}
            <tr>
                <td>{{ sel.week_start_date|date:"d M" }} - {{ sel.week_end_date|date:"d M Y" }}</td>
                <td>{{ sel.generated_by }}</td>
                <td>{{ sel.items.count }}</td>
                <td>{{ sel.completed_count|default:0 }}</td>
                <td>{{ sel.skipped_count|default:0 }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endblock %}
